'use strict';

const Toast = new function() {
    this.initialize = function() {
        this.toast = bootstrap.Toast.getOrCreateInstance(document.getElementById('toastMessage'));
    };
    this.show = function(message) {
        $(".toastMessage").empty().append(message);
        Toast.toast.show();
    };
};

const Folder = new function() {
    this.selected = "0";
    this.refresh = function() {
        window.location.reload();
    };
    this.open = function(folderId) {
        Folder.selected = folderId;
        AjaxUtil.GET({
            url: Folder.context+"/api/drive/"+folderId,
            callBack: Drive.open
        });
    };
    this.initialize = function() {
        this.context = $("#container").data("context");
        this.selected = "0";
        $(".btnCreateFolder").on("click", function(e) {
            e.preventDefault();
            if($("#folder-name").val().trim() != "") {
                var callBack = function(response) {
                    if(response.success) {
                        Folder.open(response.persistId);
                        $('#createFolderModal').modal('hide');
                        Toast.show("Folder created successfully!");
                    }
                };
                AjaxUtil.POST({
                    url: Folder.context+"/api/folder",
                    data: {name: $("#folder-name").val(), parent :{id: Folder.selected}},
                    callBack: callBack
                });
            }else {
                $("#folder-name").addClass("is-invalid");
            }
        });
        $("#folder-name").on("focus", function(e){
            e.preventDefault();
            $(this).removeClass("is-invalid");
        });
        $(".btn-close, .btnCancelFolder").on("click", function(e) {
            e.preventDefault();
            $("#folder-name").removeClass("is-invalid");
            $("#folder-name").val("");
        });
    };
};
const File = new function() {
    this.upload = function(folderId) {
        var fileInput = $('#fileSelected')[0].files[0];
        var formData = new FormData();
        formData.append('file', fileInput);
        if(fileInput === undefined) {
            $("#fileSelected").addClass("is-invalid");
            $("#fileSelected").closest(".invalid-feedback").append("Please choose a file or image.");
            return false;
        }
        if (fileInput.size > (10 * 1024 * 1024)) {
            $("#fileSelected").addClass("is-invalid");
            $("#fileSelected").closest(".invalid-feedback").append("File size exceeds 10MB limit.");
            return false;
        }
        let callBack = function(response) {
            if(response.success) {
                $('#uploadFileModal').modal('hide');
                if(Folder.selected != "0") {
                    Folder.open(Folder.selected);
                    Toast.show("File uploaded successfully!");
                }else {
                    Folder.refresh();
                }
            }
        };
        AjaxUtil.UPLOAD({
             url: File.context + "/api/file/upload/"+folderId,
             formData: formData,
             callBack: callBack
        });
    };
    this.fileIcons = {
       'pdf': 'fa-file-pdf', // CSS class for PDF icon
       'doc': 'fa-file-word', // CSS class for Word icon
       'docx': 'fa-file-word', // CSS class for Word icon
       'xls': 'fa-file-excel', // CSS class for Excel icon
       'xlsx': 'fa-file-excel', // CSS class for Excel icon
       'jpg': 'fa-image', // CSS class for JPEG icon
       'jpeg': 'fa-image', // CSS class for JPEG icon
       'png': 'fa-image', // CSS class for PNG icon
       'gif': 'fa-image', // CSS class for GIF icon
       'txt': 'fa-file-lines', // CSS class for Text file icon
       'default': 'fa-file' // CSS class for default icon
    };
    this.getFileExtension = function(fileName) {
        return fileName.split('.').pop().toLowerCase();
    };
    this.icon = function(fileName) {
        const ext = File.getFileExtension(fileName);
        return File.fileIcons[ext] || File.fileIcons["default"];
    };
    this.isImage = function(fileName) {
        var imageIcons = {
           'jpg': 'fa-image',
           'jpeg': 'fa-image',
           'png': 'fa-image',
           'gif': 'fa-image'
        };
        const ext = File.getFileExtension(fileName);
        if(File.fileIcons[ext]) {
            return true;
        } else {
            return false;
        }
    };
    this.showImage = function(id) {
        var myModal = new bootstrap.Modal(document.getElementById('imageViewModal'), {
          keyboard: false
        });
        myModal.show();
    };
    this.initialize = function() {
        this.context = $("#container").data("context");
        $(".btnUploadFile").on("click", function(e) {
            e.preventDefault();
            File.upload(Folder.selected);
        });
        $("#fileSelected").on("change", function(e) {
            e.preventDefault();
            $(this).removeClass("is-invalid");
        });
        $(".btn-close, .btnCancelFile").on("click", function(e) {
            e.preventDefault();
            $("#fileSelected").removeClass("is-invalid");
        });
    };
};
const HTMLStyle = new function() {
    this.contextOfFolder = function(folder) {
        const ul = $("<ul/>").attr({class: "dropdown-menu w-auto position-absolute end-0"});
        const aOpen = $("<a/>").attr({class: "dropdown-item folder-name", href: "javascript:;", id: folder.id}).append("Open");
        const liOpen = $("<li/>").append(aOpen);
        ul.append(liOpen);
        const aRename = $("<a/>").attr({class: "dropdown-item disabled", href: "javascript:;"}).append("Rename");
        const liRename = $("<li/>").append(aRename);
        ul.append(liRename);
        const aDelete = $("<a/>").attr({class: "dropdown-item disabled", href: "javascript:;"}).append("Delete");
        const liDelete = $("<li/>").append(aDelete);
        ul.append(liDelete);
        const aProperties = $("<a/>").attr({class: "dropdown-item folder-properties", href: "javascript:;", id: folder.id}).append("Properties");
        const liProperties = $("<li/>").append(aProperties);
        ul.append(liProperties);
        return ul;
    };
    this.contextOfFile = function(file) {
        const ul = $("<ul/>").attr({class: "dropdown-menu w-auto position-absolute end-0"});
        if(File.isImage(file.name)) {
            const aOpen = $("<a/>").attr({class: "dropdown-item file-name", href: "javascript:;", id: file.id}).append("Open");
            const liOpen = $("<li/>").append(aOpen);
            ul.append(liOpen);
        }
        const aShare = $("<a/>").attr({class: "dropdown-item share-file", href: "javascript:;", id: file.id}).append("Share");
        const liShare = $("<li/>").append(aShare);
        ul.append(liShare);
        const aRename = $("<a/>").attr({class: "dropdown-item disabled", href: "javascript:;"}).append("Rename");
        const liRename = $("<li/>").append(aRename);
        ul.append(liRename);
        const aDelete = $("<a/>").attr({class: "dropdown-item delete-file", href: "javascript:;", id: file.id}).append("Delete");
        const liDelete = $("<li/>").append(aDelete);
        ul.append(liDelete);
        const aProperties = $("<a/>").attr({class: "dropdown-item file-properties", href: "javascript:;", id: file.id}).append("Properties");
        const liProperties = $("<li/>").append(aProperties);
        ul.append(liProperties);
        return ul;
    };
    this.createFolder = function(folder) {
        const divCol = $("<div/>").attr({class: "col-sm-5 col-md-5 col-lg-5 col-xl-5 col-xxl-5 py-2 border border-1 rounded-1"});
        const divColR = $("<div/>").attr({class: "row position-relative"});
        const divColIcon = $("<div/>").attr({class: "col-sm-1 col-md-1 col-lg-1 col-xl-1 col-xxl-1"});
        divColIcon.append("<i class='fa fa-folder text-success'></i>")
        divColR.append(divColIcon);
        const divColName = $("<a/>").attr({class: "col-sm-11 col-md-11 col-lg-11 col-xl-11 col-xxl-11 folder-name text-decoration-none text-dark text-ellipsis", href: "javascript:;", id: folder.id, title: folder.name});
        divColName.append(folder.name);
        divColR.append(divColName);
        divColR.append(HTMLStyle.contextOfFolder(folder));
        divCol.append(divColR);
        return divCol;
    };
    this.createFile = function(file) {
        const divCol = $("<div/>").attr({class: "col-sm-5 col-md-5 col-lg-5 col-xl-5 col-xxl-5 py-2 border border-1 rounded-1"});
        const divColR = $("<div/>").attr({class: "row position-relative"});
        const divColIcon = $("<div/>").attr({class: "col-sm-1 col-md-1 col-lg-1 col-xl-1 col-xxl-1"});
        divColIcon.append("<i class='fa "+File.icon(file.name)+" text-success'></i>")
        divColR.append(divColIcon);
        const divColName = $("<a/>").attr({class: "col-sm-11 col-md-11 col-lg-11 col-xl-11 col-xxl-11 file-name text-decoration-none text-dark text-ellipsis "+(File.isImage(file.name) ? 'image-view':''), href: "javascript:;", id: file.id, title: file.originalName});
        divColName.append(file.originalName);
        divColR.append(divColName);
        divColR.append(HTMLStyle.contextOfFile(file));
        divCol.append(divColR);
        return divCol;
    };
    this.breadcrumb = function(context, data, active) {
        var elements = "";
        if(data) {
            if(data.prev) {
                elements += HTMLStyle.breadcrumb(context, data.prev, false);
            }
            if(active) {
                elements += "<li class='breadcrumb-item active'>"+data.name+"</li>";
            }else if(data.id){
                elements += "<li class='breadcrumb-item'><a href='javascript:;' class='folder-name text-decoration-none' id='"+data.id+"'>"+data.name+"</a></li>";
            }else {
                elements += "<li class='breadcrumb-item'><a href='"+context+"' class='text-decoration-none'>"+data.name+"</a></li>";
            }
        }
        return elements;
    };
};

const Drive = new function() {
    this.events = function() {
        $(".folder-name").on("click", function(e) {
            e.preventDefault();
            Folder.open($(this).attr("id"));
        });
        $(".folder-name, .file-name").on("contextmenu", function(e) {
            e.preventDefault();
            $(".position-relative").find(".dropdown-menu").removeClass("d-block");
            $(this).parent(".position-relative").find(".dropdown-menu").addClass("d-block");
        });
        $(".image-view").on("click", function(e) {
            e.preventDefault();
            File.showImage($(this).attr("id"));
        });
        $(".btnView").on("click", function(e) {
            e.preventDefault();
            let callBack = function(response) {
                if(response.success) {
                    if(Folder.selected != "0") {
                        Folder.open(Folder.selected);
                    }else {
                        Folder.refresh();
                    }
                }
            };
            AjaxUtil.POST({
                url: Drive.context+"/api/drive/view",
                data: {keyword: "DRIVE_DEFAULT_VIEW", value: $(this).data("value")},
                callBack: callBack
            });
        });
    };
    this.open = function(response) {
        var data = response.data;
        $(".driveContent").empty();
        if(response.data) {
            $(".btnView").removeClass("active");
            if(response.data.view) {
                $(".btnView").each(function() {
                    if($(this).data("value") == response.data.view){
                        $(this).addClass("active");
                    }
                });
            }
            var folder = response.data.folder;
            $(".breadcrumb").empty().append(HTMLStyle.breadcrumb(Drive.context, response.data.breadcrumb, true));
            var folders = folder.subFolders;
            var divRow = $("<div/>").attr({class: "row mx-0 justify-content-between gap-4"});
            for(let index = 0; index < folders.length; index++) {
                divRow.append(HTMLStyle.createFolder(folders[index]));
            }
            if(folders.length > 0) {
                 $(".driveContent").append("<h6 class='text-muted'>Folders</h6>");
                 $(".driveContent").append(divRow);
            }
            var files = folder.files;
            var divFileRow = $("<div/>").attr({class: "row mx-0 justify-content-between gap-4"});
            for(let index = 0; index < files.length; index++) {
                divFileRow.append(HTMLStyle.createFile(files[index]));
            }
            if(files.length > 0) {
                if(folders.length > 0) {
                   $(".driveContent").append("<h6 class='text-muted mt-4'>Files</h6>");
                }else {
                   $(".driveContent").append("<h6 class='text-muted'>Files</h6>");
                }
                $(".driveContent").append(divFileRow);
            }
            if(folders.length == 0 && files.length == 0 ) {
                $(".driveContent").append("It looks like your folder is currently empty.");
            }
        }
        Drive.events();
    };

    this.load = function(response) {
        $(".driveContent").empty();
        if(response.data) {
            $(".btnView").removeClass("active");
            if(response.data.view) {
                $(".btnView").each(function() {
                    if($(this).data("value") == response.data.view){
                        $(this).addClass("active");
                    }
                });
            }
            $(".breadcrumb").empty().append(HTMLStyle.breadcrumb(Drive.context, response.data.breadcrumb, true));
            var folders = response.data.folders;
            var divRow = $("<div/>").attr({class: "row mx-0 justify-content-between gap-4"});
            for(let index = 0; index < folders.length; index++) {
                divRow.append(HTMLStyle.createFolder(folders[index]));
            }
            if(folders.length > 0) {
                 $(".driveContent").append("<h6 class='text-muted'>Folders</h6>");
                 $(".driveContent").append(divRow);
            }
            var files = response.data.files;
            var divFileRow = $("<div/>").attr({class: "row mx-0 justify-content-between gap-4"});
            for(let index = 0; index < files.length; index++) {
                divFileRow.append(HTMLStyle.createFile(files[index]));
            }
            if(files.length > 0) {
                if(folders.length > 0) {
                   $(".driveContent").append("<h6 class='text-muted mt-4'>Files</h6>");
                }else {
                   $(".driveContent").append("<h6 class='text-muted'>Files</h6>");
                }
                $(".driveContent").append(divFileRow);
            }
            if(folders.length == 0 && files.length == 0 ) {
                $(".driveContent").append("It looks like your drive is currently empty.");
            }
        }
        Drive.events();
    };
    this.initialize = function() {
        this.context = $("#container").data("context");
        AjaxUtil.GET({
            url: Drive.context+"/api/drive",
            callBack: Drive.load
        });
    };
};
Folder.initialize();
Drive.initialize();
File.initialize();
Toast.initialize();