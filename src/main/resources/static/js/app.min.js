'use strict';
const contextPath = $("#container").data("context");
function disableNavigation() {
    history.pushState(null, null, window.location.href);
    window.addEventListener('popstate', function (event) {
        history.pushState(null, null, window.location.href);
    });
}
// Call the function to disable both back and forward navigation

const Folder = new function() {
    this.selected = "";
    this.refresh = function() {
        window.location.reload();
        disableNavigation();
    };
    this.open = function(folderId) {
        Folder.selected = folderId;
        AjaxUtil.GET({
            url: contextPath+"/api/folder/"+folderId,
            callBack: Drive.open
        });
    };
    this.initialize = function() {
        this.selected = "";
        $(".btnCreateFolder").on("click", function(e) {
            e.preventDefault();
            if($("#folder-name").val().trim() != "") {
                AjaxUtil.POST({
                    url: contextPath+"/api/folder",
                    data: {name: $("#folder-name").val(), parent :{id: Folder.selected}},
                    callBack: Folder.refresh
                });
            }else {
                $("#folder-name").addClass("is-invalid");
            }
        });
        $("#folder-name").on("focus", function(){
            $(this).removeClass("is-invalid");
        });
        $(".btn-close, .btnCancelFolder").on("click", function() {
            $("#folder-name").removeClass("is-invalid");
            $("#folder-name").val("");
        });
    };
};

const Drive = new function() {
    this.events = function() {
        $(".folder-name").on("click", function(e) {
            e.preventDefault();
            Folder.open($(this).attr("id"));
        });
    };
    this.open = function(response) {
        var data = response.data;
        $(".driveContent").empty();
        $(".card-subtitle").empty().append("<a href='"+contextPath+"/my-drive' class='text-decoration-none'>My Drive</a>").append(" / ").append(data.name);
        disableNavigation();
    };
    this.load = function(response) {
        $(".driveContent").empty();
        $(".card-subtitle").empty().append("My Drive");
        if(response.data) {
            var counter = 1;
            var folders = response.data.folders;
            var files = response.data.files;
            if(folders.length > 0) {
                 $(".driveContent").append("<h6 class='text-muted'>Folders</h6>");
            }
            var divRow = $("<div/>").attr({class: "row justify-content-between gap-4"});
            for(let index = 0; index < folders.length; index++) {
                const divCol = $("<div/>").attr({class: "col-sm-5 col-md-5 col-lg-5 col-xl-5 col-xxl-5 py-2 "+(counter == 2 ? "float-end":"")+" border border-1 rounded-1"});
                const divColR = $("<div/>").attr({class: "row"});
                const divColIcon = $("<div/>").attr({class: "col-sm-1 col-md-1 col-lg-1 col-xl-1 col-xxl-1"});
                divColIcon.append("<i class='fa fa-folder text-success'></i>")
                divColR.append(divColIcon);
                const divColName = $("<a/>").attr({class: "col-sm-10 col-md-10 col-lg-10 col-xl-10 col-xxl-10 folder-name text-decoration-none text-dark", href: "javascript:;", id: folders[index].id});
                divColName.append(folders[index].name);
                divColR.append(divColName);
                const divColOptions = $("<a/>").attr({class: "col-sm-1 col-md-1 col-lg-1 col-xl-1 col-xxl-1 folder-options", href: "javascript:;", id: folders[index].id});
                divColOptions.append('<i class="fa-solid fa-ellipsis-vertical text-dark"></i>');
                divColR.append(divColOptions);
                divCol.append(divColR);
                divRow.append(divCol);
                if(counter == 2) {
                    counter = 1
                }
                counter++;
            }
            $(".driveContent").append(divRow);
            if(folders.length == 0 && files.length == 0 ) {
                $(".driveContent").append("It looks like your drive is currently empty.");
            }
        }
        Drive.events();
        disableNavigation();
    };
    this.initialize = function() {
        AjaxUtil.GET({
            url: contextPath+"/api/folder",
            callBack: Drive.load
        });
    };
};
Folder.initialize();
Drive.initialize();